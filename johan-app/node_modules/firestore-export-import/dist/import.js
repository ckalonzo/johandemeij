"use strict";var __awaiter=(this&&this.__awaiter)||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value);});}
return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}
function rejected(value){try{step(generator["throw"](value));}catch(e){reject(e);}}
function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected);}
step((generator=generator.apply(thisArg,_arguments||[])).next());});};var __generator=(this&&this.__generator)||function(thisArg,body){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1];},trys:[],ops:[]},f,y,t,g=Object.create((typeof Iterator==="function"?Iterator:Object).prototype);return g.next=verb(0),g["throw"]=verb(1),g["return"]=verb(2),typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this;}),g;function verb(n){return function(v){return step([n,v]);};}
function step(op){if(f)throw new TypeError("Generator is already executing.");while(g&&(g=0,op[0]&&(_=0)),_)try{if(f=1,y&&(t=op[0]&2?y["return"]:op[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[op[0]&2,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return{value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue;}
if(op[0]===3&&(!t||(op[1]>t[0]&&op[1]<t[3]))){_.label=op[1];break;}
if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break;}
if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break;}
if(t[2])_.ops.pop();_.trys.pop();continue;}
op=body.call(thisArg,_);}catch(e){op=[6,e];y=0;}finally{f=t=0;}
if(op[0]&5)throw op[1];return{value:op[0]?op[1]:void 0,done:true};}};var __spreadArray=(this&&this.__spreadArray)||function(to,from,pack){if(pack||arguments.length===2)for(var i=0,l=from.length,ar;i<l;i++){if(ar||!(i in from)){if(!ar)ar=Array.prototype.slice.call(from,0,i);ar[i]=from[i];}}
return to.concat(ar||Array.prototype.slice.call(from));};var __importDefault=(this&&this.__importDefault)||function(mod){return(mod&&mod.__esModule)?mod:{"default":mod};};Object.defineProperty(exports,"__esModule",{value:true});exports.restoreService=void 0;var fs_1=__importDefault(require("fs"));var uuid_1=require("uuid");var helper_js_1=require("./helper.js");var restoreService=function(db,fileName,options){return new Promise(function(resolve,reject){if(typeof fileName==='object'){var dataObj=fileName;updateCollection(db,dataObj,options).then(function(){resolve({status:true,message:'Collection successfully imported!',});}).catch(function(error){reject({status:false,message:error.message});});}
else{fs_1.default.readFile(fileName,'utf8',function(err,data){if(err){console.log(err);reject({status:false,message:err.message});}
var dataObj=JSON.parse(data);updateCollection(db,dataObj,options).then(function(){resolve({status:true,message:'Collection successfully imported!',});}).catch(function(error){reject({status:false,message:error.message});});});}});};exports.restoreService=restoreService;var updateCollection=function(db_1,dataObj_1){var args_1=[];for(var _i=2;_i<arguments.length;_i++){args_1[_i-2]=arguments[_i];}
return __awaiter(void 0,__spreadArray([db_1,dataObj_1],args_1,true),void 0,function(db,dataObj,options){var _a,_b,_c,_d,index,collectionName,_e,_f,_g,_h,doc,docId,subCollections,error_1,subCollections,_j,_k,_l,_m,subIndex,revivedSubCollection,subCollectionPath;if(options===void 0){options={};}
return __generator(this,function(_o){switch(_o.label){case 0:_a=dataObj;_b=[];for(_c in _a)
_b.push(_c);_d=0;_o.label=1;case 1:if(!(_d<_b.length))return[3,16];_c=_b[_d];if(!(_c in _a))return[3,15];index=_c;collectionName=index;_e=dataObj[index];_f=[];for(_g in _e)
_f.push(_g);_h=0;_o.label=2;case 2:if(!(_h<_f.length))return[3,15];_g=_f[_h];if(!(_g in _e))return[3,14];doc=_g;if(!dataObj[index].hasOwnProperty(doc))return[3,14];docId=Array.isArray(dataObj[index])?(0,uuid_1.v1)():doc;if(!!Array.isArray(dataObj[index]))return[3,9];subCollections=dataObj[index][docId]['subCollection'];delete dataObj[index][doc]['subCollection'];_o.label=3;case 3:_o.trys.push([3,5,,6]);return[4,startUpdating(db,collectionName,docId,dataObj[index][doc],options)];case 4:_o.sent();return[3,6];case 5:error_1=_o.sent();console.error(error_1);return[3,6];case 6:if(!subCollections)return[3,8];return[4,updateCollection(db,subCollections,options)];case 7:_o.sent();_o.label=8;case 8:return[3,14];case 9:subCollections=dataObj[index][doc]['subCollection'];delete dataObj[index][doc]['subCollection'];return[4,startUpdating(db,collectionName,docId,dataObj[index][doc],options)];case 10:_o.sent();if(!subCollections)return[3,14];_j=subCollections;_k=[];for(_l in _j)
_k.push(_l);_m=0;_o.label=11;case 11:if(!(_m<_k.length))return[3,14];_l=_k[_m];if(!(_l in _j))return[3,13];subIndex=_l;revivedSubCollection={};subCollectionPath="".concat(collectionName,"/").concat(docId,"/").concat(subIndex);revivedSubCollection[subCollectionPath]=subCollections[subIndex];return[4,updateCollection(db,revivedSubCollection,options)];case 12:_o.sent();_o.label=13;case 13:_m++;return[3,11];case 14:_h++;return[3,2];case 15:_d++;return[3,1];case 16:return[2];}});});};var startUpdating=function(db,collectionName,docId,data,options){var _a;if(options.dates&&options.dates.length>0){options.dates.forEach(function(date){if(data.hasOwnProperty(date)){if(Array.isArray(data[date])){data[date]=data[date].map(function(d){return(0,helper_js_1.makeTime)(d);});}
else{data[date]=(0,helper_js_1.makeTime)(data[date]);}}
if(date.indexOf('.')>-1){(0,helper_js_1.traverseObjects)(data,function(value){if(!value.hasOwnProperty('_seconds')){return null;}
return(0,helper_js_1.makeTime)(value);});}});}
if(options.autoParseDates){(0,helper_js_1.parseAndConvertDates)(data);}
if((_a=options.refs)===null||_a===void 0?void 0:_a.length){options.refs.forEach(function(ref){if(data.hasOwnProperty(ref)){if(Array.isArray(data[ref])){data[ref]=data[ref].map(function(dataRef){return db.doc(dataRef);});}
else{data[ref]=db.doc(data[ref]);}}
else if(data.hasOwnProperty(ref.split('.')[0])){ref.split('.').reduce(function(prev,curr,index){if(Array.isArray(prev)){return prev.reduce(function(acc,c){if(typeof c[curr]==='string'){c[curr]=db.doc(c[curr]);}
else if(typeof c[curr]==='object'){return(acc=c[curr]);}
else{return acc;}},{});}
else{if(Array.isArray(prev[curr])&&ref.split('.').length===index+1){prev[curr]=prev[curr].map(function(e){return db.doc(e);});}
else if(ref.split('.').length===index+1&&prev[curr]){return(prev[curr]=db.doc(prev[curr]));}
else{return(prev[curr]=prev[curr]||null);}}},data);}});}
if(options.geos&&options.geos.length>0){options.geos.forEach(function(geo){if(data.hasOwnProperty(geo)){if(Array.isArray(data[geo])){data[geo]=data[geo].map(function(geoValues){return(0,helper_js_1.makeGeoPoint)(geoValues);});}
else{data[geo]=(0,helper_js_1.makeGeoPoint)(data[geo]);}}
if(geo.indexOf('.')>-1){(0,helper_js_1.traverseObjects)(data,function(value){if(!value.hasOwnProperty('_latitude')){return null;}
return(0,helper_js_1.makeGeoPoint)(value);});}});}
if(options.autoParseGeos){(0,helper_js_1.parseAndConvertGeos)(data);}
return new Promise(function(resolve,reject){db.collection(collectionName).doc(docId).set(data).then(function(){(options===null||options===void 0?void 0:options.showLogs)&&console.log("".concat(docId," was successfully added to firestore!"));resolve({status:true,message:"".concat(docId," was successfully added to firestore!"),});}).catch(function(error){console.log(error);reject({status:false,message:error.message,});});});};